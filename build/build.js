import rollup from 'rollup'
import fs from 'fs'
import rollupPluginJson from 'rollup-plugin-json'
import rollupPluginUrl from 'rollup-plugin-url'

import { setGameID } from './setGameID.js'
import { removeDevOnly } from './removeDevOnly.js'
import { ccMinify } from './ccMinify.js'
import { minifyMore } from './minifyMore.js'
import { minifyShaders } from './minifyShaders.js'
import { transformConstToLet } from './transformConstToLet.js'
import { transformGlConsts } from './transformGlConsts.js'
import { minifyHtml } from './minifyHtml.js'
import { zip } from './zip.js'

export async function build({ fixBeforeMinify, fixAfterHtmlMinify }) {
  const plugins = [
    rollupPluginJson(),
    rollupPluginUrl({
      limit: Infinity
    }),
    setGameID,
    transformConstToLet,
    transformGlConsts,
    {
      transformBundle: fixBeforeMinify
    },
    removeDevOnly,
    ccMinify,
    minifyMore,
    minifyShaders
  ]

  const inputOptions = {
    input: 'src/entry.js',
    plugins
  }

  const outputOptions = {
    file: 'dist/build.js',
    format: 'es'
  }

  if (!fs.existsSync('dist')){
    fs.mkdirSync('dist')
  }

  const bundle = await rollup.rollup(inputOptions)
  let { code } = await bundle.generate(outputOptions)

  let minifiedHtml = fs.readFileSync('src/index.html', { encoding: 'utf-8' })
  minifiedHtml = minifyHtml(minifiedHtml)
  minifiedHtml = fixAfterHtmlMinify(minifiedHtml)

  // Strip "use strict" generated by TODO - what is generating this?
  code = code.substring("'use strict';".length)

  let newScriptTag = `<script>${code}</script>`
  minifiedHtml = minifiedHtml
    .replace(/<script[^>]+><\/script>/, _ => newScriptTag)

  fs.writeFileSync('dist/index.html', minifiedHtml, { encoding: 'utf-8' })

  await zip('dist/index.html', 'dist/dist.zip')

  const finalFileSize = fs.readFileSync('dist/dist.zip').byteLength

  const limit = 13 * 1024
  const perc = (finalFileSize * 100 / limit).toFixed(1)
  console.log(`Final file size: ${finalFileSize} (${perc}% of 13kb)`)

  if (finalFileSize > limit) {
    console.error(`That's ${finalFileSize - limit} too many bytes!`)
  } else {
    console.log(`${limit - finalFileSize} bytes left!`)
  }
}
